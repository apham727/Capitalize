'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _access_token = require('./client/access_token');

var _access_token2 = _interopRequireDefault(_access_token);

var _listener = require('./client/listener');

var _listener2 = _interopRequireDefault(_listener);

var _request = require('./client/request');

var _request2 = _interopRequireDefault(_request);

var _validator = require('./client/validator');

var _validator2 = _interopRequireDefault(_validator);

var _package = require('../../package.json');

var _package2 = _interopRequireDefault(_package);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

/**
 * A convenient wrapper around the API, allowing for generic, authenticated and
 * unauthenticated API calls without having to manage the serialization,
 * desrialization, and authentication.
 *
 * Generally you do not need to use this object directly. Instead it is used
 * indirectly by the various namespaced methods for every API call.
 *
 * For example, the following are the semantically the same.
 *
 * ```js
 * amadeus.client.get('/v1/reference-data/urls/checkin-links', params);
 * amadeus.amadeus.reference_data.urls.checkin_links.get(params);
 * ```
 *
 * @param {Object} options a list of options. See {@link Amadeus} .
 * @property {string} clientId the API key used to authenticate the API
 * @property {string} clientSecret the API secret used to authenticate
 *  the API
 * @property {Object} logger the `console`-compatible logger used to debug calls
 * @property {string} logLevel the log level for the client, available options
 *  are `debug`, `warn`, and `silent`. Defaults to 'silent'
 * @property {string} host the hostname of the server API calls are made to
 * @property {number} port the port the server API calls are made to
 * @property {boolean} ssl wether an SSL request is made to the server
 * @property {string} customAppId the custom App ID to be passed in the User
 *  Agent to the server
 * @property {string} customAppVersion the custom App Version number to be
 *  passed in the User Agent to the server
 * @property {Object} http the Node/HTTP(S)-compatible client used to make
 *  requests
 * @property {number} version The version of this API client
 */
var Client = function () {
  function Client() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    _classCallCheck(this, Client);

    new _validator2.default().validateAndInitialize(this, options);
    this.accessToken = new _access_token2.default(this);
    this.version = _package2.default.version;
  }

  /**
   * Make an authenticated GET API call.
   *
   * ```js
   * amadeus.client.get('/v2/foo/bar', { some: 'data' });
   * ```
   * @param {string} path the full path of the API endpoint
   * @param {Object} [params={}] the query string parameters
   * @return {Promise.<Response,ResponseError>} a Promise
   */


  _createClass(Client, [{
    key: 'get',
    value: function get(path) {
      var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      return this.request('GET', path, params);
    }

    /**
     * Make an authenticated POST API call.
     *
     * ```js
     * amadeus.client.post('/v2/foo/bar', { some: 'data' });
     * ```
     * @param {string} path the full path of the API endpoint
     * @param {Object} [params={}] the POST parameters
     * @return {Promise.<Response,ResponseError>} a Promise
     */

  }, {
    key: 'post',
    value: function post(path) {
      var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      return this.request('POST', path, params);
    }

    // PROTECTED

    /**
     * Make an authenticated API call.
     *
     * ```js
     * amadeus.client.call('GET', '/v2/foo/bar', { some: 'data' });
     * ```
     * @param {string} verb the HTTP method, for example `GET` or `POST`
     * @param {string} path the full path of the API endpoint
     * @param {Object} [params={}] the POST parameters
     * @return {Promise.<Response,ResponseError>} a Promise
     * @protected
     */

  }, {
    key: 'request',
    value: function request(verb, path) {
      var _this = this;

      var params = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};

      return this.accessToken.bearerToken(this).then(function (bearerToken) {
        return _this.unauthenticatedRequest(verb, path, params, bearerToken);
      });
    }

    // PRIVATE

    /**
     * Make any kind of API call, authenticated or not
     *
     * Used by the .get, .post methods to make API calls.
     *
     * Sets up a new Promise and then excutes the API call, triggering the Promise
     * to be called when the API call fails or succeeds.
     *
     * @param {string} verb the HTTP method, for example `GET` or `POST`
     * @param {string} path the full path of the API endpoint
     * @param {Object} params the parameters to pass in the query or body
     * @param {string} [bearerToken=null] the BearerToken as generated by the
     *  AccessToken class
     * @return {Promise.<Response,ResponseError>} a Promise
     * @private
     */

  }, {
    key: 'unauthenticatedRequest',
    value: function unauthenticatedRequest(verb, path, params) {
      var bearerToken = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : null;

      var request = this.buildRequest(verb, path, params, bearerToken);
      this.log(request);
      var emitter = new _events2.default();
      var promise = this.buildPromise(emitter);

      this.execute(request, emitter);
      return promise;
    }

    /**
     * Actually executes the API call.
     *
     * @param {Request} request the request to execute
     * @param {EventEmitter} emitter the event emitter to notify of changes
     * @private
     */

  }, {
    key: 'execute',
    value: function execute(request, emitter) {
      var http_request = this.http.request(request.options());
      var listener = new _listener2.default(request, emitter, this);
      http_request.on('response', listener.onResponse.bind(listener));
      http_request.on('error', listener.onError.bind(listener));
      http_request.write(request.body());
      http_request.end();
    }

    /**
     * Builds a Request object to be used in the API call
     *
     * @param {string} verb the HTTP method, for example `GET` or `POST`
     * @param {string} path the full path of the API endpoint
     * @param {Object} params the parameters to pass in the query or body
     * @param {string} [bearerToken=null] the BearerToken as generated by the
     *  AccessToken class
     * @return {Request}
     * @private
     */

  }, {
    key: 'buildRequest',
    value: function buildRequest(verb, path, params, bearerToken) {
      return new _request2.default({
        host: this.host,
        verb: verb,
        path: path,
        params: params,
        bearerToken: bearerToken,
        clientVersion: this.version,
        languageVersion: process.version,
        appId: this.customAppId,
        appVersion: this.customAppVersion,
        port: this.port,
        ssl: this.ssl
      });
    }

    /**
     * Builds a Bluebird Promise to be returned to the API user
     *
     * @param  {type} emitter the event emitter to notify of changes
     * @return {Promise} a Bluebird promise
     * @private
     */

  }, {
    key: 'buildPromise',
    value: function buildPromise(emitter) {
      return new _bluebird2.default(function (resolve, reject) {
        emitter.on('resolve', function (response) {
          return resolve(response);
        });
        emitter.on('reject', function (error) {
          return reject(error);
        });
      });
    }

    /**
     * Logs the request, when in debug mode
     *
     * @param  {Request} request the request object to log
     * @private
     */

  }, {
    key: 'log',
    value: function log(request) {
      /* istanbul ignore next */
      if (this.debug()) {
        this.logger.log(_util2.default.inspect(request, false, null));
      }
    }

    /**
     * Determines if this client is in debug mode
     *
     * @return {boolean}
     */

  }, {
    key: 'debug',
    value: function debug() {
      return this.logLevel == 'debug';
    }

    /**
     * Determines if this client is in warn or debug mode
     *
     * @return {boolean}
     */

  }, {
    key: 'warn',
    value: function warn() {
      return this.logLevel == 'warn' || this.debug();
    }
  }]);

  return Client;
}();

exports.default = Client;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hbWFkZXVzL2NsaWVudC5qcyJdLCJuYW1lcyI6WyJDbGllbnQiLCJvcHRpb25zIiwiVmFsaWRhdG9yIiwidmFsaWRhdGVBbmRJbml0aWFsaXplIiwiYWNjZXNzVG9rZW4iLCJBY2Nlc3NUb2tlbiIsInZlcnNpb24iLCJwa2ciLCJwYXRoIiwicGFyYW1zIiwicmVxdWVzdCIsInZlcmIiLCJiZWFyZXJUb2tlbiIsInRoZW4iLCJ1bmF1dGhlbnRpY2F0ZWRSZXF1ZXN0IiwiYnVpbGRSZXF1ZXN0IiwibG9nIiwiZW1pdHRlciIsIkV2ZW50RW1pdHRlciIsInByb21pc2UiLCJidWlsZFByb21pc2UiLCJleGVjdXRlIiwiaHR0cF9yZXF1ZXN0IiwiaHR0cCIsImxpc3RlbmVyIiwiTGlzdGVuZXIiLCJvbiIsIm9uUmVzcG9uc2UiLCJiaW5kIiwib25FcnJvciIsIndyaXRlIiwiYm9keSIsImVuZCIsIlJlcXVlc3QiLCJob3N0IiwiY2xpZW50VmVyc2lvbiIsImxhbmd1YWdlVmVyc2lvbiIsInByb2Nlc3MiLCJhcHBJZCIsImN1c3RvbUFwcElkIiwiYXBwVmVyc2lvbiIsImN1c3RvbUFwcFZlcnNpb24iLCJwb3J0Iiwic3NsIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJyZXNwb25zZSIsImVycm9yIiwiZGVidWciLCJsb2dnZXIiLCJ1dGlsIiwiaW5zcGVjdCIsImxvZ0xldmVsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7Ozs7O0FBRUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQWlDTUEsTTtBQUNKLG9CQUEwQjtBQUFBLFFBQWRDLE9BQWMsdUVBQUosRUFBSTs7QUFBQTs7QUFDeEIsUUFBSUMsbUJBQUosR0FBZ0JDLHFCQUFoQixDQUFzQyxJQUF0QyxFQUE0Q0YsT0FBNUM7QUFDQSxTQUFLRyxXQUFMLEdB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QVIsQ0FBVyxTQUFYLEVBQXNCO0FBQUEsaUJBQVltQixRQUFRRSxRQUFSLENBQVo7QUFBQSxTQUF0QjtBQUNBOUIsZ0JBQVFTLEVBQVIsQ0FBVyxRQUFYLEVBQXFCO0FBQUEsaUJBQVNvQixPQUFPRSxLQUFQLENBQVQ7QUFBQSxTQUFyQjtBQUNELE9BSE0sQ0FBUDtBQUlEOztBQUdEOzs7Ozs7Ozs7d0JBTUl0QyxPLEVBQVM7QUFDWDtBQUNBLFVBQUcsS0FBS3VDLEtBQUwsRUFBSCxFQUFpQjtBQUFFLGFBQUtDLE1BQUwsQ0FBWWxDLEdBQVosQ0FBZ0JtQyxlQUFLQyxPQUFMLENBQWExQyxPQUFiLEVBQXNCLEtBQXRCLEVBQTZCLElBQTdCLENBQWhCO0FBQXNEO0FBQzFFOztBQUVEOzs7Ozs7Ozs0QkFLUTtBQUNOLGFBQU8sS0FBSzJDLFFBQUwsSUFBaUIsT0FBeEI7QUFDRDs7QUFFRDs7Ozs7Ozs7MkJBS087QUFDTCxhQUFPLEtBQUtBLFFBQUwsSUFBaUIsTUFBakIsSUFBMkIsS0FBS0osS0FBTCxFQUFsQztBQUNEOzs7Ozs7a0JBR1lqRCxNIiwiZmlsZSI6ImNsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCBQcm9taXNlICAgICAgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHV0aWwgICAgICAgICBmcm9tICd1dGlsJztcblxuaW1wb3J0IEFjY2Vzc1Rva2VuIGZyb20gJy4vY2xpZW50L2FjY2Vzc190b2tlbic7XG5pbXBvcnQgTGlzdGVuZXIgICAgZnJvbSAnLi9jbGllbnQvbGlzdGVuZXInO1xuaW1wb3J0IFJlcXVlc3QgICAgIGZyb20gJy4vY2xpZW50L3JlcXVlc3QnO1xuaW1wb3J0IFZhbGlkYXRvciAgIGZyb20gJy4vY2xpZW50L3ZhbGlkYXRvcic7XG5cbmltcG9ydCBwa2cgICAgICAgICBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nO1xuXG4vKipcbiAqIEEgY29udmVuaWVudCB3cmFwcGVyIGFyb3VuZCB0aGUgQVBJLCBhbGxvd2luZyBmb3IgZ2VuZXJpYywgYXV0aGVudGljYXRlZCBhbmRcbiAqIHVuYXV0aGVudGljYXRlZCBBUEkgY2FsbHMgd2l0aG91dCBoYXZpbmcgdG8gbWFuYWdlIHRoZSBzZXJpYWxpemF0aW9uLFxuICogZGVzcmlhbGl6YXRpb24sIGFuZCBhdXRoZW50aWNhdGlvbi5cbiAqXG4gKiBHZW5lcmFsbHkgeW91IGRvIG5vdCBuZWVkIHRvIHVzZSB0aGlzIG9iamVjdCBkaXJlY3RseS4gSW5zdGVhZCBpdCBpcyB1c2VkXG4gKiBpbmRpcmVjdGx5IGJ5IHRoZSB2YXJpb3VzIG5hbWVzcGFjZWQgbWV0aG9kcyBmb3IgZXZlcnkgQVBJIGNhbGwuXG4gKlxuICogRm9yIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgYXJlIHRoZSBzZW1hbnRpY2FsbHkgdGhlIHNhbWUuXG4gKlxuICogYGBganNcbiAqIGFtYWRldXMuY2xpZW50LmdldCgnL3YxL3JlZmVyZW5jZS1kYXRhL3VybHMvY2hlY2tpbi1saW5rcycsIHBhcmFtcyk7XG4gKiBhbWFkZXVzLmFtYWRldXMucmVmZXJlbmNlX2RhdGEudXJscy5jaGVja2luX2xpbmtzLmdldChwYXJhbXMpO1xuICogYGBgXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgYSBsaXN0IG9mIG9wdGlvbnMuIFNlZSB7QGxpbmsgQW1hZGV1c30gLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGNsaWVudElkIHRoZSBBUEkga2V5IHVzZWQgdG8gYXV0aGVudGljYXRlIHRoZSBBUElcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjbGllbnRTZWNyZXQgdGhlIEFQSSBzZWNyZXQgdXNlZCB0byBhdXRoZW50aWNhdGVcbiAqICB0aGUgQVBJXG4gKiBAcHJvcGVydHkge09iamVjdH0gbG9nZ2VyIHRoZSBgY29uc29sZWAtY29tcGF0aWJsZSBsb2dnZXIgdXNlZCB0byBkZWJ1ZyBjYWxsc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGxvZ0xldmVsIHRoZSBsb2cgbGV2ZWwgZm9yIHRoZSBjbGllbnQsIGF2YWlsYWJsZSBvcHRpb25zXG4gKiAgYXJlIGBkZWJ1Z2AsIGB3YXJuYCwgYW5kIGBzaWxlbnRgLiBEZWZhdWx0cyB0byAnc2lsZW50J1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGhvc3QgdGhlIGhvc3RuYW1lIG9mIHRoZSBzZXJ2ZXIgQVBJIGNhbGxzIGFyZSBtYWRlIHRvXG4gKiBAcHJvcGVydHkge251bWJlcn0gcG9ydCB0aGUgcG9ydCB0aGUgc2VydmVyIEFQSSBjYWxscyBhcmUgbWFkZSB0b1xuICogQHByb3BlcnR5IHtib29sZWFufSBzc2wgd2V0aGVyIGFuIFNTTCByZXF1ZXN0IGlzIG1hZGUgdG8gdGhlIHNlcnZlclxuICogQHByb3BlcnR5IHtzdHJpbmd9IGN1c3RvbUFwcElkIHRoZSBjdXN0b20gQXBwIElEIHRvIGJlIHBhc3NlZCBpbiB0aGUgVXNlclxuICogIEFnZW50IHRvIHRoZSBzZXJ2ZXJcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjdXN0b21BcHBWZXJzaW9uIHRoZSBjdXN0b20gQXBwIFZlcnNpb24gbnVtYmVyIHRvIGJlXG4gKiAgcGFzc2VkIGluIHRoZSBVc2VyIEFnZW50IHRvIHRoZSBzZXJ2ZXJcbiAqIEBwcm9wZXJ0eSB7T2JqZWN0fSBodHRwIHRoZSBOb2RlL0hUVFAoUyktY29tcGF0aWJsZSBjbGllbnQgdXNlZCB0byBtYWtlXG4gKiAgcmVxdWVzdHNcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2ZXJzaW9uIFRoZSB2ZXJzaW9uIG9mIHRoaXMgQVBJIGNsaWVudFxuICovXG5jbGFzcyBDbGllbnQge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICBuZXcgVmFsaWRhdG9yKCkudmFsaWRhdGVBbmRJbml0aWFsaXplKHRoaXMsIG9wdGlvbnMpO1xuICAgIHRoaXMuYWNjZXNzVG9rZW4gPSBuZXcgQWNjZXNzVG9rZW4odGhpcyk7XG4gICAgdGhpcy52ZXJzaW9uID0gcGtnLnZlcnNpb247XG4gIH1cblxuICAvKipcbiAgICogTWFrZSBhbiBhdXRoZW50aWNhdGVkIEdFVCBBUEkgY2FsbC5cbiAgICpcbiAgICogYGBganNcbiAgICogYW1hZGV1cy5jbGllbnQuZ2V0KCcvdjIvZm9vL2JhcicsIHsgc29tZTogJ2RhdGEnIH0pO1xuICAgKiBgYGBcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggdGhlIGZ1bGwgcGF0aCBvZiB0aGUgQVBJIGVuZHBvaW50XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBbcGFyYW1zPXt9XSB0aGUgcXVlcnkgc3RyaW5nIHBhcmFtZXRlcnNcbiAgICogQHJldHVybiB7UHJvbWlzZS48UmVzcG9uc2UsUmVzcG9uc2VFcnJvcj59IGEgUHJvbWlzZVxuICAgKi9cbiAgZ2V0KHBhdGgsIHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCgnR0VUJywgcGF0aCwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYWtlIGFuIGF1dGhlbnRpY2F0ZWQgUE9TVCBBUEkgY2FsbC5cbiAgICpcbiAgICogYGBganNcbiAgICogYW1hZGV1cy5jbGllbnQucG9zdCgnL3YyL2Zvby9iYXInLCB7IHNvbWU6ICdkYXRhJyB9KTtcbiAgICogYGBgXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHRoZSBmdWxsIHBhdGggb2YgdGhlIEFQSSBlbmRwb2ludFxuICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtcz17fV0gdGhlIFBPU1QgcGFyYW1ldGVyc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlLjxSZXNwb25zZSxSZXNwb25zZUVycm9yPn0gYSBQcm9taXNlXG4gICAqL1xuICBwb3N0KHBhdGgsIHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMucmVxdWVzdCgnUE9TVCcsIHBhdGgsIHBhcmFtcyk7XG4gIH1cblxuICAvLyBQUk9URUNURURcblxuICAvKipcbiAgICogTWFrZSBhbiBhdXRoZW50aWNhdGVkIEFQSSBjYWxsLlxuICAgKlxuICAgKiBgYGBqc1xuICAgKiBhbWFkZXVzLmNsaWVudC5jYWxsKCdHRVQnLCAnL3YyL2Zvby9iYXInLCB7IHNvbWU6ICdkYXRhJyB9KTtcbiAgICogYGBgXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2ZXJiIHRoZSBIVFRQIG1ldGhvZCwgZm9yIGV4YW1wbGUgYEdFVGAgb3IgYFBPU1RgXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoIHRoZSBmdWxsIHBhdGggb2YgdGhlIEFQSSBlbmRwb2ludFxuICAgKiBAcGFyYW0ge09iamVjdH0gW3BhcmFtcz17fV0gdGhlIFBPU1QgcGFyYW1ldGVyc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlLjxSZXNwb25zZSxSZXNwb25zZUVycm9yPn0gYSBQcm9taXNlXG4gICAqIEBwcm90ZWN0ZWRcbiAgICovXG4gIHJlcXVlc3QodmVyYiwgcGF0aCwgcGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5hY2Nlc3NUb2tlbi5iZWFyZXJUb2tlbih0aGlzKS50aGVuKChiZWFyZXJUb2tlbikgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudW5hdXRoZW50aWNhdGVkUmVxdWVzdCh2ZXJiLCBwYXRoLCBwYXJhbXMsIGJlYXJlclRva2VuKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIFBSSVZBVEVcblxuICAvKipcbiAgICogTWFrZSBhbnkga2luZCBvZiBBUEkgY2FsbCwgYXV0aGVudGljYXRlZCBvciBub3RcbiAgICpcbiAgICogVXNlZCBieSB0aGUgLmdldCwgLnBvc3QgbWV0aG9kcyB0byBtYWtlIEFQSSBjYWxscy5cbiAgICpcbiAgICogU2V0cyB1cCBhIG5ldyBQcm9taXNlIGFuZCB0aGVuIGV4Y3V0ZXMgdGhlIEFQSSBjYWxsLCB0cmlnZ2VyaW5nIHRoZSBQcm9taXNlXG4gICAqIHRvIGJlIGNhbGxlZCB3aGVuIHRoZSBBUEkgY2FsbCBmYWlscyBvciBzdWNjZWVkcy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHZlcmIgdGhlIEhUVFAgbWV0aG9kLCBmb3IgZXhhbXBsZSBgR0VUYCBvciBgUE9TVGBcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggdGhlIGZ1bGwgcGF0aCBvZiB0aGUgQVBJIGVuZHBvaW50XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgdGhlIHBhcmFtZXRlcnMgdG8gcGFzcyBpbiB0aGUgcXVlcnkgb3IgYm9keVxuICAgKiBAcGFyYW0ge3N0cmluZ30gW2JlYXJlclRva2VuPW51bGxdIHRoZSBCZWFyZXJUb2tlbiBhcyBnZW5lcmF0ZWQgYnkgdGhlXG4gICAqICBBY2Nlc3NUb2tlbiBjbGFzc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlLjxSZXNwb25zZSxSZXNwb25zZUVycm9yPn0gYSBQcm9taXNlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICB1bmF1dGhlbnRpY2F0ZWRSZXF1ZXN0KHZlcmIsIHBhdGgsIHBhcmFtcywgYmVhcmVyVG9rZW4gPSBudWxsKSB7XG4gICAgbGV0IHJlcXVlc3QgPSB0aGlzLmJ1aWxkUmVxdWVzdCh2ZXJiLCBwYXRoLCBwYXJhbXMsIGJlYXJlclRva2VuKTtcbiAgICB0aGlzLmxvZyhyZXF1ZXN0KTtcbiAgICBsZXQgZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICBsZXQgcHJvbWlzZSA9IHRoaXMuYnVpbGRQcm9taXNlKGVtaXR0ZXIpO1xuXG4gICAgdGhpcy5leGVjdXRlKHJlcXVlc3QsIGVtaXR0ZXIpO1xuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEFjdHVhbGx5IGV4ZWN1dGVzIHRoZSBBUEkgY2FsbC5cbiAgICpcbiAgICogQHBhcmFtIHtSZXF1ZXN0fSByZXF1ZXN0IHRoZSByZXF1ZXN0IHRvIGV4ZWN1dGVcbiAgICogQHBhcmFtIHtFdmVudEVtaXR0ZXJ9IGVtaXR0ZXIgdGhlIGV2ZW50IGVtaXR0ZXIgdG8gbm90aWZ5IG9mIGNoYW5nZXNcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGV4ZWN1dGUocmVxdWVzdCwgZW1pdHRlcikge1xuICAgIGxldCBodHRwX3JlcXVlc3QgPSB0aGlzLmh0dHAucmVxdWVzdChyZXF1ZXN0Lm9wdGlvbnMoKSk7XG4gICAgbGV0IGxpc3RlbmVyID0gbmV3IExpc3RlbmVyKHJlcXVlc3QsIGVtaXR0ZXIsIHRoaXMpO1xuICAgIGh0dHBfcmVxdWVzdC5vbigncmVzcG9uc2UnLCBsaXN0ZW5lci5vblJlc3BvbnNlLmJpbmQobGlzdGVuZXIpKTtcbiAgICBodHRwX3JlcXVlc3Qub24oJ2Vycm9yJywgICAgbGlzdGVuZXIub25FcnJvci5iaW5kKGxpc3RlbmVyKSk7XG4gICAgaHR0cF9yZXF1ZXN0LndyaXRlKHJlcXVlc3QuYm9keSgpKTtcbiAgICBodHRwX3JlcXVlc3QuZW5kKCk7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGRzIGEgUmVxdWVzdCBvYmplY3QgdG8gYmUgdXNlZCBpbiB0aGUgQVBJIGNhbGxcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IHZlcmIgdGhlIEhUVFAgbWV0aG9kLCBmb3IgZXhhbXBsZSBgR0VUYCBvciBgUE9TVGBcbiAgICogQHBhcmFtIHtzdHJpbmd9IHBhdGggdGhlIGZ1bGwgcGF0aCBvZiB0aGUgQVBJIGVuZHBvaW50XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgdGhlIHBhcmFtZXRlcnMgdG8gcGFzcyBpbiB0aGUgcXVlcnkgb3IgYm9keVxuICAgKiBAcGFyYW0ge3N0cmluZ30gW2JlYXJlclRva2VuPW51bGxdIHRoZSBCZWFyZXJUb2tlbiBhcyBnZW5lcmF0ZWQgYnkgdGhlXG4gICAqICBBY2Nlc3NUb2tlbiBjbGFzc1xuICAgKiBAcmV0dXJuIHtSZXF1ZXN0fVxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgYnVpbGRSZXF1ZXN0KHZlcmIsIHBhdGgsIHBhcmFtcywgYmVhcmVyVG9rZW4pIHtcbiAgICByZXR1cm4gbmV3IFJlcXVlc3Qoe1xuICAgICAgaG9zdDogdGhpcy5ob3N0LFxuICAgICAgdmVyYjogdmVyYixcbiAgICAgIHBhdGg6IHBhdGgsXG4gICAgICBwYXJhbXM6IHBhcmFtcyxcbiAgICAgIGJlYXJlclRva2VuOiBiZWFyZXJUb2tlbixcbiAgICAgIGNsaWVudFZlcnNpb246IHRoaXMudmVyc2lvbixcbiAgICAgIGxhbmd1YWdlVmVyc2lvbjogcHJvY2Vzcy52ZXJzaW9uLFxuICAgICAgYXBwSWQ6IHRoaXMuY3VzdG9tQXBwSWQsXG4gICAgICBhcHBWZXJzaW9uOiB0aGlzLmN1c3RvbUFwcFZlcnNpb24sXG4gICAgICBwb3J0OiB0aGlzLnBvcnQsXG4gICAgICBzc2w6IHRoaXMuc3NsXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGRzIGEgQmx1ZWJpcmQgUHJvbWlzZSB0byBiZSByZXR1cm5lZCB0byB0aGUgQVBJIHVzZXJcbiAgICpcbiAgICogQHBhcmFtICB7dHlwZX0gZW1pdHRlciB0aGUgZXZlbnQgZW1pdHRlciB0byBub3RpZnkgb2YgY2hhbmdlc1xuICAgKiBAcmV0dXJuIHtQcm9taXNlfSBhIEJsdWViaXJkIHByb21pc2VcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGJ1aWxkUHJvbWlzZShlbWl0dGVyKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGVtaXR0ZXIub24oJ3Jlc29sdmUnLCByZXNwb25zZSA9PiByZXNvbHZlKHJlc3BvbnNlKSk7XG4gICAgICBlbWl0dGVyLm9uKCdyZWplY3QnLCBlcnJvciA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIExvZ3MgdGhlIHJlcXVlc3QsIHdoZW4gaW4gZGVidWcgbW9kZVxuICAgKlxuICAgKiBAcGFyYW0gIHtSZXF1ZXN0fSByZXF1ZXN0IHRoZSByZXF1ZXN0IG9iamVjdCB0byBsb2dcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGxvZyhyZXF1ZXN0KSB7XG4gICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICBpZih0aGlzLmRlYnVnKCkpIHsgdGhpcy5sb2dnZXIubG9nKHV0aWwuaW5zcGVjdChyZXF1ZXN0LCBmYWxzZSwgbnVsbCkpOyB9XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lcyBpZiB0aGlzIGNsaWVudCBpcyBpbiBkZWJ1ZyBtb2RlXG4gICAqXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBkZWJ1ZygpIHtcbiAgICByZXR1cm4gdGhpcy5sb2dMZXZlbCA9PSAnZGVidWcnO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgaWYgdGhpcyBjbGllbnQgaXMgaW4gd2FybiBvciBkZWJ1ZyBtb2RlXG4gICAqXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICB3YXJuKCkge1xuICAgIHJldHVybiB0aGlzLmxvZ0xldmVsID09ICd3YXJuJyB8fCB0aGlzLmRlYnVnKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2xpZW50O1xuIl19